<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Forrest Sitemap Reference</title>
<link type="text/css" href="skin/page.css" rel="stylesheet">
<link rel="shortcut icon" href="favicon.ico">
</head>
<body text="#000000" bgcolor="#FFFFFF">
<!--================= start Navigation Path ==================-->
<table summary="navigation path" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td nowrap="nowrap" valign="middle" bgcolor="#CFDCED" height="20"><img height="1" width="5" alt="" src="skin/images/spacer.gif" class="spacer"><!--===== breadcrumb trail (javascript-generated) ====--><font size="2" face="Arial, Helvetica, Sans-serif"><a href="http://www.apache.org/">apache</a> &gt; <a href="http://xml.apache.org/">xml.apache</a><script src="skin/breadcrumbs.js" language="JavaScript" type="text/javascript"></script></font></td>
</tr>
<tr>
<td bgcolor="#4C6C8F" height="2"><img height="2" width="2" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
</table>
<!--================= end Navigation Path ==================-->
<!--================= start Banner ==================-->
<table summary="header with logos" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<!--================= start Group Logo ==================-->
<td bgcolor="#294563"><a href="http://xml.apache.org/"><img class="logoImage" alt="Apache XML" src="images/group-logo.gif"></a></td>
<!--================= end Group Logo ==================-->
<!--================= start Project Logo ==================--><td width="100%" align="center" bgcolor="#294563"><a href="http://xml.apache.org/forrest/"><img class="logoImage" alt="Forrest" src="images/project-logo.gif"></a></td>
<!--================= end Project Logo ==================-->
<!--================= start Search ==================--><td valign="top" rowspan="2" bgcolor="#294563">
<form target="_blank" action="http://www.google.com/search" method="get">
<table summary="search" border="0" cellspacing="0" cellpadding="0" bgcolor="#4C6C8F">
<tr>
<td colspan="3"><img height="10" width="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<tr>
<td><img height="1" width="1" alt="" src="skin/images/spacer.gif" class="spacer"></td><td nowrap="nowrap"><input value="xml.apache.org" name="as_sitesearch" type="hidden"><input size="15" name="as_q" id="query" type="text"><img height="1" width="5" alt="" src="skin/images/spacer.gif" class="spacer"><input name="Search" value="Search" type="submit">
<br>
<font face="Arial, Helvetica, Sans-serif" size="2" color="white">
                          the Apache XML site
                          
                          
                        </font></td><td><img height="1" width="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<tr>
<td><img alt="" border="0" height="10" width="9" src="skin/images/search-left.gif"></td><td><img height="1" width="1" alt="" src="skin/images/spacer.gif" class="spacer"></td><td><img alt="" border="0" height="10" width="9" src="skin/images/search-right.gif"></td>
</tr>
</table>
</form>
</td>
<!--================= end Search ==================--><td bgcolor="#294563"><img height="10" width="10" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<tr>
<td valign="bottom" bgcolor="#294563" colspan="2">
<!--================= start Tabs ==================-->
<div class="tab">
<table summary="tab bar" border="0" cellpadding="0" cellspacing="0">
<tr>
<td width="6"><img alt="" height="8" width="6" src="skin/images/spacer.gif"></td><td valign="bottom">
<table summary="selected tab" style="height: 1.8em" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top" width="5" bgcolor="#4C6C8F"><img height="5" width="5" alt="" src="skin/images/tabSel-left.gif"></td><td valign="middle" bgcolor="#4C6C8F"><font color="#ffffff" size="2" face="Arial, Helvetica, Sans-serif"><b><a class="base-selected" href="index.html">Home</a></b></font></td><td valign="top" width="5" bgcolor="#4C6C8F"><img height="5" width="5" alt="" src="skin/images/tabSel-right.gif"></td>
</tr>
</table>
</td><td width="6"><img alt="" height="8" width="6" src="skin/images/spacer.gif"></td><td valign="bottom">
<table summary="non selected tab" style="height: 1.6em" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top" width="5" bgcolor="#B2C4E0"><img height="5" width="5" alt="" src="skin/images/tab-left.gif"></td><td valign="middle" bgcolor="#B2C4E0"><a class="base-not-selected" href="community/index.html">Community</a></td><td valign="top" width="5" bgcolor="#B2C4E0"><img height="5" width="5" alt="" src="skin/images/tab-right.gif"></td>
</tr>
<tr>
<td colspan="3" height="1"></td>
</tr>
</table>
</td><td width="6"><img alt="" height="8" width="6" src="skin/images/spacer.gif"></td><td valign="bottom">
<table summary="non selected tab" style="height: 1.6em" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top" width="5" bgcolor="#B2C4E0"><img height="5" width="5" alt="" src="skin/images/tab-left.gif"></td><td valign="middle" bgcolor="#B2C4E0"><a class="base-not-selected" href="community/howto/index.html">How-to</a></td><td valign="top" width="5" bgcolor="#B2C4E0"><img height="5" width="5" alt="" src="skin/images/tab-right.gif"></td>
</tr>
<tr>
<td colspan="3" height="1"></td>
</tr>
</table>
</td>
</tr>
</table>
</div>
<!--================= end Tabs ==================-->
</td><td bgcolor="#294563"></td>
</tr>
<tr>
<td height="10" bgcolor="#4C6C8F" colspan="4"></td>
</tr>
</table>
<!--================= end Banner ==================-->
<!--================= start Menu, NavBar, Content ==================-->
<table summary="page content" bgcolor="#ffffff" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top">
<table summary="menu" border="0" cellspacing="0" cellpadding="0">
<tr>
<!--================= start left top NavBar ==================-->
<td rowspan="3" valign="top">
<table summary="blue line" border="0" cellpadding="0" cellspacing="0">
<tr>
<td bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<tr>
<td bgcolor="#CFDCED"><font color="#4C6C8F" size="4" face="Arial, Helvetica, Sans-serif">&nbsp;</font></td>
</tr>
<tr>
<td bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
</table>
</td>
<!--================= end left top NavBar ==================--><td bgcolor="#294563"><img width="1" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td><td valign="bottom" bgcolor="#4C6C8F"><img width="10" height="10" alt="" src="skin/images/spacer.gif" class="spacer"></td><td nowrap="nowrap" valign="top" bgcolor="#4C6C8F">
<!--================= start Menu items ==================-->
<div class="menu">
<ul>
<li>
<font color="#CFDCED">About</font>
<ul>
    
<li>
<a href="index.html">Index</a>
</li>
    
<li>
<a href="license.html">License</a>
</li>
    
<li>
<a class="external" href="http://www.apache.org/dyn/closer.cgi/xml/forrest/">Download</a>
</li>
    
<li>
<a href="who.html">Who we are</a>
</li>
    
<li>
<a href="faq.html">FAQs</a>
</li>
    
<li>
<a href="changes.html">Changes</a>
</li>
    
    
<li>
<a href="todo.html">Todo</a>
</li>
    
<li>
<a href="live-sites.html">Example sites</a>
</li>
  
</ul>
</li>
<li>
<font color="#CFDCED">Documentation</font>
<ul>
    
<li>
<a href="your-project.html">Using Forrest</a>
</li>
    
<li>
<a href="validation.html">XML Validation</a>
</li>
    
<li>
<a href="linking.html">Menus and Linking</a>
</li>
    
<li>
<span class="sel"><font color="#ffcc00">Sitemap Reference</font></span>
</li>
    
<li>
<a href="searching.html">Searching</a>
</li>
    
<li>
<a href="skin-package.html">Skin Packages</a>
</li>
    
    
<li>
<a href="forrest-contract.html">Our Contract</a>
</li>
    
<li>
<a href="compliance.html">Standards Compliance</a>
</li>
    
<li>
<a href="dtd-docs.html">DTD documentation</a>
</li>
    
<li>
<a href="catalog.html">Using DTD Catalogs</a>
</li>
    
<li>
<a href="cap.html">Sourcetype Action</a>
</li>
    
<li>
<a href="oowriter.html">OpenOffice Writer docs</a>
</li>    
    
<li>
<a href="forrestbar.html">The ForrestBar</a>
</li>
    
<li>
<a href="forrestbot.html">Forrestbot (CVS)</a>
</li>
    
<li>
<a href="forrestbot-old.html">Forrestbot (stable)</a>
</li>
    
    
<li>
<a href="upgrading_06.html">Upgrading to 0.6</a>
</li>
    
<li>
<a href="upgrading_05.html">Upgrading to 0.5</a>
</li>
  
</ul>
</li>
<li>
<font color="#CFDCED">Older Docs</font>
<ul>
    
<li>
<a href="primer.html">Forrest Primer</a>
</li>
    
<li>
<a href="libre-intro.html">Libre</a>
</li>
    
<li>
<a href="dreams.html">Dream list</a>
</li>
  
</ul>
</li>
<li>
<font color="#CFDCED">Some Samples</font>
<ul>
    
<li>
<a href="document-v12.html">document-v12</a>
</li>
    
<li>
<a href="wiki-sample.html">Wiki Reference</a>
</li>
 
</ul>
</li>
<li>
<font color="#CFDCED">Getting Involved</font>
<ul>
    
<li>
<a href="contrib.html">Contributing</a>
</li>
    
<li>
<a href="build.html">Building Forrest</a>
</li>
    
<li>
<a class="external" href="http://svn.apache.org/viewcvs.cgi/forrest/trunk/?root=Apache-SVN">Browse SVN</a>
</li>
    
<li>
<a href="mail-lists.html">Mail lists</a>
</li>
    
<li>
<a href="mail-archives.html">Mail Archives</a>
</li>
    
<li>
<a class="external" href="http://issues.cocoondev.org/jira/secure/BrowseProject.jspa?id=10000">Bugs and Issues</a>
</li>
    
<li>
<a href="forrest-issues.html">Open Issues</a>
</li>
  
</ul>
</li>
<li>
<font color="#CFDCED">Related projects</font>
<ul>
    
<li>
<a class="external" href="http://gump.apache.org/">Apache Gump</a>
</li>
    
<li>
<a class="external" href="http://cocoon.apache.org/">Apache Cocoon</a>
</li>
    
<li>
<a class="external" href="http://cocoon.apache.org/lenya/">Apache Lenya</a>
</li>
    
<li>
<a class="external" href="http://www.krysalis.org/">Krysalis Centipede</a>
</li>
  
</ul>
</li>
</ul>
</div>
<!--================= end Menu items ==================-->
</td><td valign="bottom" bgcolor="#4C6C8F"><img width="10" height="10" alt="" src="skin/images/spacer.gif" class="spacer"></td><td bgcolor="#294563"><img width="1" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<tr>
<td valign="bottom" align="left" colspan="2" rowspan="2" bgcolor="#4C6C8F"><img height="10" width="10" border="0" alt="" src="skin/images/menu-left.gif"></td><td bgcolor="#4C6C8F"><img height="10" width="10" alt="" src="skin/images/spacer.gif" class="spacer"></td><td valign="bottom" align="right" colspan="2" rowspan="2" bgcolor="#4C6C8F"><img height="10" width="10" border="0" alt="" src="skin/images/menu-right.gif"></td>
</tr>
<tr>
<td height="1" bgcolor="#294563"><img width="1" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
</table>
</td><td valign="top" width="100%">
<table summary="content" width="100%" border="0" cellpadding="0" cellspacing="0">
<!--================= start middle NavBar ==================-->
<tr>
<td colspan="4" bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<tr>
<td align="left" width="10" bgcolor="#CFDCED"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td><td align="left" width="50%" bgcolor="#CFDCED"><font color="#4C6C8F" size="3" face="Arial, Helvetica, Sans-serif">
                &nbsp;
                
                </font><img width="10" height="8" alt="" src="skin/images/spacer.gif" class="spacer"></td><td align="right" width="50%" bgcolor="#CFDCED"><font color="#4C6C8F" size="3" face="Arial, Helvetica, Sans-serif">
                &nbsp;
                
                </font><img width="10" height="8" alt="" src="skin/images/spacer.gif" class="spacer"></td><td width="10" bgcolor="#CFDCED"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<tr>
<td colspan="4" bgcolor="#294563"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<!--================= end middle NavBar ==================-->
<!--================= start Content==================-->
<tr>
<td align="left" width="10"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td><td colspan="2" align="left" width="100%">
<div class="content">
<table class="title" summary="">
<tr>
<td valign="middle">
<h1>Forrest Sitemap Reference</h1>
</td><td nowrap="nowrap" width="40" align="center"><a class="dida" href="sitemap-ref.pdf"><img alt="PDF" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a></td>
</tr>
</table>
<ul class="minitoc">
<li>
<a href="#getting_started">Getting started</a>
</li>
<li>
<a href="#Sitemap+Overview">Sitemap Overview</a>
</li>
<li>
<a href="#source_pipelines">Source pipelines (**.xml)</a>
<ul class="minitoc">
<li>
<a href="#forrest_xmap">forrest.xmap</a>
</li>
<li>
<a href="#Other+source+pipelines">Other source pipelines</a>
<ul class="minitoc">
<li>
<a href="#late_binding_pipelines">Late-binding pipelines</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#output_pipelines">Output pipelines</a>
<ul class="minitoc">
<li>
<a href="#PDF+output">PDF output</a>
</li>
<li>
<a href="#HTML+output">HTML output</a>
</li>
</ul>
</li>
<li>
<a href="#intermediate_pipelines">Intermediate pipelines</a>
<ul class="minitoc">
<li>
<a href="#body_pipeline">Page body</a>
</li>
<li>
<a href="#menu_pipeline">Page menu</a>
</li>
<li>
<a href="#tab_pipeline">Page tabs</a>
</li>
</ul>
</li>
<li>
<a href="#menu_xml_generation">Menu XML generation</a>
</li>
<li>
<a href="#linkrewriting_impl">Link rewriting</a>
<ul class="minitoc">
<li>
<a href="#Cocoon+foundations%3A+Input+Modules">Cocoon foundations: Input Modules</a>
</li>
<li>
<a href="#Implementing+">Implementing site:-rewriting</a>
<ul class="minitoc">
<li>
<a href="#cocoon.xconf">cocoon.xconf</a>
</li>
<li>
<a href="#sitemap.xmap">sitemap.xmap</a>
</li>
<li>
<a href="#Dynamically+generating+a+linkmap">Dynamically generating a linkmap</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
    
<p>
      Technically, Forrest can be thought of as a <a class="external" href="http://cocoon.apache.org/2.1/">Cocoon</a> distribution that has been stripped down
      and optimized for people with simple site publishing needs.  Central to
      Cocoon, and hence Forrest, is the <strong>sitemap</strong>.  The sitemap
      defines the site's URI space (what pages are available), and how each page
      is constructed.  Understanding the sitemap is the key to understanding
      Forrest.
    </p>
    
<p>
      The Cocoon sitemap syntax is documented fully <a class="external" href="http://cocoon.apache.org/2.1/userdocs/concepts/sitemap.html">in Cocoon's documentation</a>.  This page
      provides an overview of the sitemap we have written for Forrest.
    </p>
    
<a name="N10021"></a><a name="getting_started"></a>
<h3>Getting started</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        If you have a binary distribution, Forrest's sitemap comprises the
        $FORREST_HOME/context/*.xmap files.  Projects may override these files
        by copying them into src/documentation/.
      </p>
<p>
        The best way to experiment with the sitemap is to run <span class="codefrag">forrest
          run</span> on a Forrest-using site.  Changes to the
        <span class="codefrag">build/webapp/*.xmap</span> files will now be immediately visible
        on <a class="external" href="http://localhost:8888/">http://localhost:8888/</a>.
      </p>
</div>


    
<a name="N10038"></a><a name="Sitemap+Overview"></a>
<h3>Sitemap Overview</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        Forrest's sitemap is divided both physically and logically.  The most
        obvious is the physical separation.  There are no less than thirteen
        *.xmap files, each defining pipelines in a functional area.  Each *.xmap
        file has its purpose documented in comments at the top.  Here is a brief
        overview of the files, in order of importance.
      </p>
<table class="ForrestTable" cellspacing="1" cellpadding="4">
        
<tr>
          
<th colspan="1" rowspan="1"><strong>sitemap.xmap</strong></th>
          <td colspan="1" rowspan="1">Primary sitemap file, which delegates responsibility for serving
            certain URIs to the others (technically called subsitemaps).  More
            on the structure of this file later.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">forrest.xmap</th>
          <td colspan="1" rowspan="1">Sitemap defining Source pipelines, which generate the body section
            of Forrest pages. All pipelines here deliver XML in Forrest's
            intermediate 'document-v12' format, regardless of originating source
            or format.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">menu.xmap</th>
          <td colspan="1" rowspan="1">Pipelines defining the XML that becomes the menu.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">linkmap.xmap</th>
          <td colspan="1" rowspan="1">Defines a mapping from abstract ('site:index') to physical
            ('../index.html') links for the current page.  See <a href="linking.html">Menus and Linking</a> for a conceptual
            overview, and the <a href="#linkrewriting_impl">Link
              rewriting</a> section for technical details.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">resources.xmap</th>
          <td colspan="1" rowspan="1">Serves 'resource' files (images, CSS, Javascript).</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">raw.xmap</th>
          <td colspan="1" rowspan="1">Serves files located in <span class="codefrag">src/documentation/content/</span>
            that are not to be modified by Forrest.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">aggregate.xmap</th>
          <td colspan="1" rowspan="1">Generates a single page (HTML or PDF) containing all the content
            for the site.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">faq.xmap</th>
          <td colspan="1" rowspan="1">Processes FAQ documents.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">status.xmap</th>
          <td colspan="1" rowspan="1">Generates <a href="changes.html">changes</a> and <a href="todo.html">todo</a> pages from a single
            <span class="codefrag">status.xml</span> in the project root.
          </td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">issues.xmap</th>
          <td colspan="1" rowspan="1">Generates a page of content from an RSS feed.  Used in Forrest to
            generate a 'current issues' list from JIRA.</td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">revisions.xmap</th>
          <td colspan="1" rowspan="1">
            Support for HOWTO documents that want 'revisions'.  Revisions are
            XML snippets containing comments on the main XML file.  The main
            pipeline here automatically appends a page's revisions to the
            bottom.
          </td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">dtd.xmap</th>
          <td colspan="1" rowspan="1">A Source pipeline that generates XML from a DTD, using Andy
            Clark's <a href="http://xml.apache.org/~andyc/neko/doc/dtd/index.html">DTD
              Parser</a>.  Useful for documenting DTD-based XML schemas, such
            as <a href="dtd-docs.html">Forrest's own DTDs</a>.
          </td>
        
</tr>
        
<tr>
          
<th colspan="1" rowspan="1">profiler.xmap</th>
          <td colspan="1" rowspan="1">Defines the 'profiler' pipeline. allowing pipelines to be benchmarked.</td>
        
</tr>
      
</table>
</div>

    <!--
    <section>
      <title>Logical structure</title>
      <p>There are a few major groups of sitemap pipelines</p>
      <dl>
        <dt>Content pipelines</dt>
        <dd>These define the body (without menu and header) for HTML pages, and all the content of PDFs.</dd>
        <dt>Menu pileines.
      </dl>
    </section>
    -->

    
<a name="N1010F"></a><a name="source_pipelines"></a>
<h3>Source pipelines (**.xml)</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        Most *.xmap files (forrest, aggregate, faq, status, issues, revisions,
        dtd) define Source pipelines.  Source pipelines define the content
        (body) XML for site pages.  The input XML format can be any format
        (doc-v12, Docbook, RSS, FAQ, Howto) and from any source (local or
        remote).  The output format is always Forrest's intermediate 'doc-v12'
        format.
      </p>
<p>
        Source pipelines always have a <span class="codefrag">.xml</span> extension.  Thus, <a href="index.xml">index.xml</a> gives you the XML source for the
        index page.  Likewise, <a href="faq.xml">faq.xml</a> gives you XML
        for the FAQ (transformed from FAQ syntax), and <a href="changes.xml">changes.xml</a> returns XML from status.xml.
        Take any page, and replace its extension (<span class="codefrag">.html</span> or
        <span class="codefrag">.pdf</span>) with <span class="codefrag">.xml</span>, and you'll have the Source
        XML.
      </p>
<p>
        This is quite powerful, because we now have an abstraction layer, or
        'virtual filesystem', on which the rest of Forrest's sitemap can build.
        Subsequent layers don't need to care whether the XML was obtained
        locally or remotely, or from what format.  Wikis, RSS, FAQs and Docbook
        files are all processed identically from here on.
      </p>
<pre class="code">
                   (subsequent Forrest pipelines)
                                 |
--------+------------------------^------------------------------------------
        |          STANDARD FORREST FORMAT (current doc-v12)
        +-----^-------^-------^-------------^------^-----^----^------^-----
SOURCE        |       |       |             |      |     |    |      |
FORMATS    doc-v10  docv11  docv12  ...  Docbook  FAQ  Howto  Wiki  RSS  ??
(*.xml)
                        (in forrest.xmap, faq.xmap, etc)
      </pre>
<a name="N1013B"></a><a name="forrest_xmap"></a>
<h4>forrest.xmap</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          Most of the usual Source pipelines are defined in
          <span class="codefrag">forrest.xmap</span>, which is the default (fallback) handler for
          <span class="codefrag">**.xml</span> pages.  forrest.xmap uses the <a href="cap.html">SourceTypeAction</a> to work out the type of XML
          it is processing, and converts it to doc-v12 if necessary.
        </p>
<p>For instance, say we are rendering <a href="community/howto/multi/step1.html">a
            Howto document</a> called 'step1.xml'.  It contains this DOCTYPE
          declaration:</p>
<pre class="code">&lt;!DOCTYPE howto PUBLIC "-//APACHE//DTD How-to V1.0//EN" "howto-v10.dtd"&gt;</pre>
<p>The SourceTypeAction sees this, and applies this transform to get it
          to doc-v12:</p>
<pre class="code">
          &lt;map:when test="howto-v10"&gt;
            &lt;map:transform src="resources/stylesheets/howto2document.xsl" /&gt;
          &lt;/map:when&gt;
          </pre>
<p>
          The intermediate result is visible at the URL <a href="community/howto/multi/step1.xml">community/howto/multi/step1.xml</a>.
        </p>
</div>
<a name="N1016A"></a><a name="Other+source+pipelines"></a>
<h4>Other source pipelines</h4>
<div style="margin-left: 0 ; border: 2px">
<p>As mentioned above, all non-core Source pipelines are distributed in
          independent <span class="codefrag">*.xmap</span> files.  There is a block of
          <span class="codefrag">sitemap.xmap</span> which simply delegates certain requests to
          these subsitemaps:</p>
<pre class="code">
      &lt;!-- Body content --&gt;
      &lt;map:match pattern="**.xml"&gt;
        &lt;map:match pattern="changes.xml"&gt;
          &lt;map:mount uri-prefix="" src="status.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;

        &lt;map:match pattern="todo.xml"&gt;
          &lt;map:mount uri-prefix="" src="status.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;

        &lt;map:match pattern="**dtdx.xml"&gt;
          &lt;map:mount uri-prefix="" src="dtd.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;

        &lt;map:match pattern="forrest-issues.xml"&gt;
          &lt;map:mount uri-prefix="" src="issues.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;

        &lt;map:match pattern="**faq.xml"&gt;
          &lt;map:mount uri-prefix="" src="faq.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;

        &lt;map:match pattern="site.xml"&gt;
          &lt;map:mount uri-prefix="" src="aggregate.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;
        ....
        ....</pre>
<a name="N1017E"></a><a name="late_binding_pipelines"></a>
<h5>Late-binding pipelines</h5>
<div style="margin-left: 0 ; border: 2px">
<p>
            One point of interest here is that the subsitemap is often not
            specific about which URLs it handles, and relies on the caller (the
            section listed above) to only pass relevant requests to it.  We term
            this "binding a URL" to a pipeline.</p>
<p>For instance, the main pipeline in <span class="codefrag">faq.xmap</span> matches
            <span class="codefrag">**.xml</span>, but only <span class="codefrag">**faq.xml</span> requests are
            sent to it.</p>
<p>This "late binding" is useful, because the whole URL space is
            managed in <span class="codefrag">sitemap.xmap</span>, and not spread over lots of
            *.xmap files.  For instance, say you wish all <span class="codefrag">*.xml</span>
            inside a <span class="codefrag">faq/</span> directory to be processed as FAQs.  Just
            override <span class="codefrag">sitemap.xmap</span>, and redefine the relevant source
            matcher:</p>
<pre class="code">
        &lt;map:match pattern="**faq.xml"&gt;
          &lt;map:mount uri-prefix="" src="faq.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;</pre>
</div>
</div>
</div>

    
<a name="N101AA"></a><a name="output_pipelines"></a>
<h3>Output pipelines</h3>
<div style="margin-left: 0 ; border: 2px">
<p>
        To recap, we now have a <span class="codefrag">*.xml</span> pipeline defined for each
        page in the site, emitting standardized XML.  These pipeline definitions
        are located in various *.xmap files, notably forrest.xmap.
      </p>
<p>
        We now wish to render the XML from these pipelines to output formats
        like HTML and PDF.
      </p>
<a name="N101B9"></a><a name="PDF+output"></a>
<h4>PDF output</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          Easiest case first; PDFs don't require menus or headers, so we can
          simply transform our intermediate format into XSL:FO, and from there
          to PDF.  This is done by the following matcher in
          <span class="codefrag">sitemap.xmap</span>:
        </p>
<pre class="code">
1   &lt;map:match type="regexp" pattern="^(.*?)([^/]*).pdf$"&gt;
2     &lt;map:generate src="cocoon:/{1}{2}.xml"/&gt;
3     &lt;map:transform type="xinclude"/&gt;
4     &lt;map:transform type="<a href="#linkrewriting_impl">linkrewriter</a>" src="cocoon://{1}linkmap-{2}.pdf"/&gt;
5     &lt;map:transform src="skins/{forrest:skin}/xslt/fo/document2fo.xsl"&gt;
6       &lt;map:parameter name="ctxbasedir" value="{realpath:.}/"/&gt;
7       &lt;map:parameter name="xmlbasedir" value="content/xdocs/{1}"/&gt;
8     &lt;/map:transform&gt;
9     &lt;map:serialize type="fo2pdf"/&gt;
10  &lt;/map:match&gt;
        </pre>
<ol>
          
<li>The first line uses a matching regexp to break the URL into
            directory <span class="codefrag">(.*?)</span> and filename
            <span class="codefrag">([^/]*)</span> part.</li>
          
<li>We then generate XML from a <a href="#source_pipelines">Source
              pipeline</a>, with the URL <span class="codefrag">cocoon:/{1}{2}.xml</span>
</li>
          
<li>We then expand any XInclude statements..</li>
          
<li>and <a href="#linkrewriting_impl">rewrite links</a>..</li>
          
<li>and finally apply the document2fo.xsl stylesheet, to generate
            XSL:FO XML.</li>
        
</ol>
<p>Lastly, we generate a PDF using the fo2pdf serializer.</p>
</div>
<a name="N101F4"></a><a name="HTML+output"></a>
<h4>HTML output</h4>
<div style="margin-left: 0 ; border: 2px">
<p>Generating HTML pages is more complicated, because we have to merge
          the page body with a menu and tabs, and then add a header and footer.
          Here is the <span class="codefrag">*.html</span> matcher in
          <span class="codefrag">sitemap.xmap</span>:</p>
<pre class="code">
          &lt;map:match pattern="*.html"&gt;
            &lt;map:aggregate element="site"&gt;
            &lt;map:part src="<a href="#tab_pipeline">cocoon:/tab-{0}</a>"/&gt;
            &lt;map:part src="<a href="#menu_pipeline">cocoon:/menu-{0}</a>"/&gt;
            &lt;map:part src="<a href="#body_pipeline">cocoon:/body-{0}</a>"/&gt;
            &lt;/map:aggregate&gt;
            &lt;map:call resource="skinit"&gt;
              &lt;map:parameter name="type" value="site2xhtml"/&gt;
              &lt;map:parameter name="path" value="{0}"/&gt;
            &lt;/map:call&gt;
          &lt;/map:match&gt;
        </pre>
<p>
          So <a href="index.html">index.html</a> is formed from
          aggregating <a href="body-index.html">body-index.html</a>, <a href="menu-index.html">menu-index.html</a> and <a href="tab-index.html">tab-index.html</a>, and then applying the
          <span class="codefrag">site2xhtml.xsl</span> stylesheet to the result.
        </p>
<p>
          There is a nearly identical matcher for HTML files in subdirectories:
        </p>
<pre class="code">
          &lt;map:match pattern="**/*.html"&gt;
            &lt;map:aggregate element="site"&gt;
            &lt;map:part src="<a href="#tab_pipeline">cocoon:/{1}/tab-{2}.html</a>"/&gt;
            &lt;map:part src="<a href="#menu_pipeline">cocoon:/{1}/menu-{2}.html</a>"/&gt;
            &lt;map:part src="<a href="#body_pipeline">cocoon:/{1}/body-{2}.html</a>"/&gt;
            &lt;/map:aggregate&gt;
            &lt;map:call resource="skinit"&gt;
              &lt;map:parameter name="type"
                value="site2xhtml"/&gt;
              &lt;map:parameter name="path"
                value="{0}"/&gt;
            &lt;/map:call&gt;
          &lt;/map:match&gt;
        </pre>
</div>
</div>
    
<a name="N10240"></a><a name="intermediate_pipelines"></a>
<h3>Intermediate pipelines</h3>
<div style="margin-left: 0 ; border: 2px">
<a name="N10246"></a><a name="body_pipeline"></a>
<h4>Page body</h4>
<div style="margin-left: 0 ; border: 2px">
<p>Here is the matcher which generates the page body:</p>
<pre class="code">
1   &lt;map:match pattern="**body-*.html"&gt;
2     &lt;map:generate src="cocoon:/{1}{2}.xml"/&gt;
3     &lt;map:transform type="idgen"/&gt;
4     &lt;map:transform type="xinclude"/&gt;
5     &lt;map:transform type="<a href="#linkrewriting_impl">linkrewriter</a>" src="cocoon:/{1}linkmap-{2}.html"/&gt;
6     &lt;map:call resource="skinit"&gt;
7       &lt;map:parameter name="type" value="document2html"/&gt;
8       &lt;map:parameter name="path" value="{1}{2}.html"/&gt;
9       &lt;map:parameter name="notoc" value="false"/&gt;
10    &lt;/map:call&gt;
11  &lt;/map:match&gt;
          </pre>
<ol>
          
<li>In our matcher pattern, {1} will be the directory (if any) and {2}
            will be the filename.</li>
          
<li>First, we obtain XML content from a source pipeline</li>
          
<li>
            
<p>We then apply a custom-written
              <span class="codefrag">IdGeneratorTransformer</span>, which ensures that every
              &lt;section&gt; has an 'id' attribute, by generating one from the
              &lt;title&gt; if necessary.  For example, &lt;idgen&gt; will
              transform:</p>
            
<pre class="code">
              &lt;section&gt;
              &lt;title&gt;How to boil eggs&lt;/title&gt;
              ...
            </pre>
            
<p>into:</p>
            
<pre class="code">
              &lt;section id="How+to+boil+eggs"&gt;
              &lt;title&gt;How to boil eggs&lt;/title&gt;
              ...
            </pre>
            
<p>Later, the <span class="codefrag">document2html.xsl</span> stylesheet will create
              an &lt;a name&gt; element for every section, allowing this section to
              be referred to as <span class="codefrag">index.html#How+to+boil+eggs</span>.</p>
          
</li>
          
<li>We then expand XInclude elements.</li>
          
<li>and <a href="#linkrewriting_impl">rewrite links</a>..</li>
          
<li>and then finally apply the stylesheet that generates a fragment of
            HTML (minus the outer elements like
            &lt;html&gt; and &lt;body&gt;) suitable for merging with the menu and tabs.</li>
        
</ol>
</div>
<a name="N1028E"></a><a name="menu_pipeline"></a>
<h4>Page menu</h4>
<div style="margin-left: 0 ; border: 2px">
<p>In <span class="codefrag">sitemap.xmap</span>, the matcher generating HTML for the menu is:</p>
<pre class="code">
      &lt;map:match pattern="**menu-*.html"&gt;
        &lt;map:generate src="cocoon:/{1}book-{2}.html"/&gt;
        &lt;map:transform type="<a href="#linkrewriting_impl">linkrewriter</a>" src="cocoon:/{1}linkmap-{2}.html"/&gt;
        &lt;map:call resource="skinit"&gt;
          &lt;map:parameter name="type" value="book2menu"/&gt;
          &lt;map:parameter name="path" value="{1}{2}.html"/&gt;
        &lt;/map:call&gt;
      &lt;/map:match&gt;
      </pre>
<p>We get XML from a 'book' pipeline, <a href="#linkrewriting_impl">rewrite links</a>, and apply the
          <span class="codefrag">book2menu.xsl</span> stylesheet to generate HTML.</p>
<p>How the menu XML is actually generated (the *book-*.html pipeline) is
          sufficiently complex to require a <a href="#menu_xml_generation">section of its own</a>.</p>
</div>
<a name="N102B5"></a><a name="tab_pipeline"></a>
<h4>Page tabs</h4>
<div style="margin-left: 0 ; border: 2px">
<p>Tab generation is quite tame compared to menus:</p>
<pre class="code">
     &lt;map:match pattern="**tab-*.html"&gt;
       &lt;map:generate src="content/xdocs/tabs.xml" /&gt;
       &lt;map:transform type="<a href="#linkrewriting_impl">linkrewriter</a>" src="cocoon:/{1}linkmap-{2}.html"/&gt;
       &lt;map:call resource="skinit"&gt;
         &lt;map:parameter name="type" value="tab2menu"/&gt;
         &lt;map:parameter name="path" value="{1}{2}.html"/&gt;
       &lt;/map:call&gt;
     &lt;/map:match&gt;
           </pre>
<p>All the smarts are in the <span class="codefrag">tab2menu.xsl</span> stylesheet, which
          needs to choose the correct tab based on the current path.  Currently,
          a "longest matching path" algorithm is implemented.  See the
          <span class="codefrag">tab2menu.xsl</span> stylesheet for details.</p>
</div>
</div>

    
<a name="N102D2"></a><a name="menu_xml_generation"></a>
<h3>Menu XML generation</h3>
<div style="margin-left: 0 ; border: 2px">
<p>The 'book' pipeline is defined in <span class="codefrag">sitemap.xmap</span>as:</p>
<pre class="code">
        &lt;map:match pattern="**book-*.html"&gt;
          &lt;map:mount uri-prefix="" src="menu.xmap" check-reload="yes" /&gt;
        &lt;/map:match&gt;
        </pre>
<p>Meaning that it is defined in <span class="codefrag">menu.xmap</span>.  In there we find
        the real definition, which is quite complicated, because there are three
        supported menu systems (see <a href="linking.html">menus and
          linking</a>).  We will not do through the sitemap itself
        (menu.xmap), but will instead describe the logical steps involved:</p>
<ol>
        
<li>Take site.xml, and expand hrefs so that they are all
          root-relative.</li>
        
<li>
<p>Depending on the <span class="codefrag">forrest.menu-scheme</span> property, we
            now apply one of the two algorithms for choosing a set of menu links
            (described in <a href="linking.html#menu_generation">menu
              generation</a>):</p>
          
<ul>
            
<li>
              
<p>
                For "@tab" menu generation, we first ensure each site.xml node
                has a tab attribute (inherited from a parent if necessary), and
                then pass through nodes whose tab attribute matches that of the
                "current" node.
              </p>
              
<p>
                For example, say our current page's path is
                <span class="codefrag">community/howto/index.html</span>.  In
                <span class="codefrag">site.xml</span> we look for the node with this
                <span class="codefrag">href</span>, and discover its <span class="codefrag">tab</span> attribute
                value is <span class="codefrag">howtos</span>.  We then prune the
                <span class="codefrag">site.xml</span>-derived content to contain only nodes with
                <span class="codefrag">tab="howtos"</span>.
              </p>
              
<p>
                All this is done with XSLT, so the sitemap snippet does not
                reveal this complexity:
              </p>
              
<pre class="code">
&lt;map:transform src="resources/stylesheets/site2site-normalizetabs.xsl" /&gt;
&lt;map:transform src="resources/stylesheets/site2site-selectnode.xsl"&gt;
  &lt;map:parameter name="path" value="{1}{2}"/&gt;
&lt;/map:transform&gt;
                </pre>
            
</li>
            
<li>
              
<p>For 'directory' menu generation, we simply use an
                <span class="codefrag">XPathTransformer</span> to include only pages in the
                current page's directory, or below:</p>
              
<pre class="code">
&lt;map:transform type="xpath"&gt;
  &lt;map:parameter name="include" value="//*[@href='{1}']" /&gt;
&lt;/map:transform&gt;
                </pre>
              
<p>
                Here, <span class="codefrag">{1}</span> is the directory part of the current
                page.  So if our current page is
                <span class="codefrag">community/howto/index.html</span>, <span class="codefrag">{1}</span> will
                be <span class="codefrag">community/howto/</span>, and the transformer will
                include all nodes in that directory.
              </p>
            
</li>
          
</ul>
          
<p>We now have a <span class="codefrag">site.xml</span> subset relevant to our current
            page.</p>
        
</li>
        
<li>The <span class="codefrag">href</span> nodes in this are then made relative to the
          current page.</li>
        
<li>The XML is then transformed into a legacy <span class="codefrag">'book.xml'</span>
          format, for compatibility with existing stylesheets, and this XML
          format is returned (hence the name of the matcher;
          <span class="codefrag">**book-*.html</span>).</li>
      
</ol>
</div>

    
<a name="N1035B"></a><a name="linkrewriting_impl"></a>
<h3>Link rewriting</h3>
<div style="margin-left: 0 ; border: 2px">
<p>In numerous places in <span class="codefrag">sitemap.xmap</span>, you will see the
        "linkrewriter" transformer in action.  For example:</p>
<pre class="code">&lt;map:transform type="linkrewriter" src="cocoon:/{1}linkmap-{2}.html"/&gt;</pre>
<p>This statement is Cocoon's linking system in action.  A full
        description is provided in <a href="linking.html">Menus and
          Linking</a>.  Here we describe the implementation of linking.</p>
<a name="N10373"></a><a name="Cocoon+foundations%3A+Input+Modules"></a>
<h4>Cocoon foundations: Input Modules</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          The implementation of <span class="codefrag">site:</span> linking is heavily based on
          Cocoon <a class="external" href="http://cocoon.apache.org/2.1/userdocs/concepts/modules.html">Input Modules</a>, a
          little-known but quite powerful aspect of Cocoon.  Input Modules are
          generic Components which simply allow you to look up a value with a
          key.  The value is generally dynamically generated, or obtained by
          querying an underlying data source.
        </p>
<p>
          In particular, Cocoon contains an <span class="codefrag">XMLFileModule</span>, which
          lets one look up the value of an XML node, by interpreting the key as
          an XPath expression.  Cocoon also has a
          <span class="codefrag">SimpleMappingMetaModule</span>, which allows the key to be
          rewritten before it is used to look up a value.
        </p>
<p>
          The idea for putting these together to rewrite <span class="codefrag">site:</span>
          links was described in <a class="external" href="http://marc.theaimsgroup.com/?t=103992708800001&r=1&w=2">this
            thread</a>. The idea is to write a Cocoon Transformer that
          triggers on encountering &lt;link
          href="<span class="codefrag">scheme:address</span>"&gt;, and interprets the
          <span class="codefrag">scheme:address</span> internal URI as
          <span class="codefrag">inputmodule:key</span>.  The transformer then uses the named
          InputModule to look up the key value. The <span class="codefrag">scheme:address</span>
          URI is then rewritten with the found value.  This transformer was
          implemented as <a class="external" href="http://nagoya.apache.org/bugzilla/show_bug.cgi?id=15611">LinkRewriterTransformer</a>,
          currently distributed as a "block" in Cocoon 2.1.
        </p>
</div>
<a name="N103A7"></a><a name="Implementing+"></a>
<h4>Implementing site:-rewriting</h4>
<div style="margin-left: 0 ; border: 2px">
<p>
          Using the above components, <span class="codefrag">site:</span> URI rewriting is
          accomplished as follows.
        </p>
<a name="N103B6"></a><a name="cocoon.xconf"></a>
<h5>cocoon.xconf</h5>
<div style="margin-left: 0 ; border: 2px">
<p>First, we declare all the input modules we will be needing:</p>
<pre class="code">
&lt;!-- For the site: scheme --&gt;
&lt;component-instance
  class="org.apache.cocoon.components.modules.input.XMLFileModule"
  logger="core.modules.xml" name="linkmap"/&gt;

&lt;!-- Links to URIs within the site --&gt;
&lt;component-instance
  class="org.apache.cocoon.components.modules.input.SimpleMappingMetaModule"
  logger="core.modules.mapper" name="site"/&gt;

&lt;!-- Links to external URIs, as distinct from 'site' URIs --&gt;
&lt;component-instance
  class="org.apache.cocoon.components.modules.input.SimpleMappingMetaModule"
  logger="core.modules.mapper" name="ext"/&gt;
</pre>
<ul>
            
<li>
<strong>linkmap</strong> will provide access to the contents of
              <span class="codefrag">site.xml</span>; for example, <span class="codefrag">linkmap:/site/about/index/@href</span>
              should return the value 'index.html'.</li>
            
<li>
<strong>site</strong> provides a 'mask' over
              <strong>linkmap</strong> such that <span class="codefrag">site:index</span> expands
              to <span class="codefrag">linkmap:/site//index/@href</span>.
            </li>
            
<li>
<strong>ext</strong> provides another 'mask' over
              <strong>linkmap</strong>, such that <span class="codefrag">ext:ant</span> would
              expand to <span class="codefrag">linkmap:/site/external-refs//ant/@href</span>
            
</li>
          
</ul>
<p>However at the moment, we have only declared the input modules.
            They will be configured in <span class="codefrag">sitemap.xmap</span> as described in
            the next section.</p>
</div>
<a name="N103F5"></a><a name="sitemap.xmap"></a>
<h5>sitemap.xmap</h5>
<div style="margin-left: 0 ; border: 2px">
<p>
            Now in the sitemap, we define the LinkRewriterTransformer, and
            insert it into any pipelines dealing with user-editable XML
            content:
          </p>
<pre class="code">
....
&lt;!-- Rewrites links, e.g. transforming
     href="site:index" to href="../index.html"
--&gt;
&lt;map:transformer name="linkrewriter"
  logger="sitemap.transformer.linkrewriter"
  src="org.apache.cocoon.transformation.LinkRewriterTransformer"&gt;
  &lt;link-attrs&gt;href src&lt;/link-attrs&gt;
  &lt;schemes&gt;site ext&lt;/schemes&gt;

  &lt;input-module name="site"&gt;
    &lt;input-module name="linkmap"&gt;
      &lt;file src="{src}" reloadable="false" /&gt;
    &lt;/input-module&gt;
    &lt;prefix&gt;/site//&lt;/prefix&gt;
    &lt;suffix&gt;/@href&lt;/suffix&gt;
  &lt;/input-module&gt;
  &lt;input-module name="ext"&gt;
    &lt;input-module name="linkmap"&gt;
      &lt;file src="{src}" reloadable="false" /&gt;
    &lt;/input-module&gt;
    &lt;prefix&gt;/site/external-refs//&lt;/prefix&gt;
    &lt;suffix&gt;/@href&lt;/suffix&gt;
  &lt;/input-module&gt;
&lt;/map:transformer&gt;
....
....
&lt;map:match pattern="**body-*.html"&gt;
  &lt;map:generate src="cocoon:/{1}{2}.xml"/&gt;
  &lt;map:transform type="idgen"/&gt;
  &lt;map:transform type="xinclude"/&gt;
  &lt;map:transform type="linkrewriter" src="cocoon:/{1}linkmap-{2}.html"/&gt;
  ...
&lt;/map:match&gt;</pre>
<p>As you can see, our three input modules are configured as part of
            the LinkRewriterTransformer's configuration.</p>
<ul>
            
<li>
              
<p>Most deeply nested, we have:</p>
              
<pre class="code">
                &lt;input-module name="linkmap"&gt;
                  &lt;file src="{src}" reloadable="false" /&gt;
              &lt;/input-module&gt;</pre>
              
<p>The <span class="codefrag">{src}</span> text is expanded to the value of the
                <span class="codefrag">src</span> attribute in the <span class="codefrag">linkrewriter</span>
                instance, namely <span class="codefrag">cocoon:/{1}linkmap-{2}.html</span>.
                Thus the <span class="codefrag">linkmap</span> module reads dynamically
                generated XML specific to the current request.</p>
            
</li>
            
<li>
              
<p>One level out, we configure the <span class="codefrag">site</span> and
                <span class="codefrag">ext</span> input modules, to map onto our dynamically
                configured <span class="codefrag">linkmap</span> module.</p>
            
</li>
            
<li>
              
<p>Then at the outermost level, we configure the
                <span class="codefrag">linkrewriter</span> transformer.  First we tell it which
                attributes to consider rewriting:</p>
              
<pre class="code">
                &lt;link-attrs&gt;href src&lt;/link-attrs&gt;
                &lt;schemes&gt;site ext&lt;/schemes&gt;</pre>
              
<p>So, <span class="codefrag">href</span> and <span class="codefrag">src</span> attributes starting
                with <span class="codefrag">site:</span> or <span class="codefrag">ext:</span> are rewritten.</p>

              
<p>By nesting the <span class="codefrag">site</span> and <span class="codefrag">ext</span> input
                modules in <span class="codefrag">linkrewriter</span>'s configuration, we tell
                <span class="codefrag">linkrewriter</span> to use these two input modules when
                rewriting links.</p>
            
</li>
          
</ul>
<p>
            The end result is that, for example, the source XML for the
            <span class="codefrag">community/body-index.html</span> page has its links rewritten
            by an XMLFileModule reading XML from
            <span class="codefrag">cocoon:/community/linkmap-index.html</span>.
          </p>
</div>
<a name="N1046B"></a><a name="Dynamically+generating+a+linkmap"></a>
<h5>Dynamically generating a linkmap</h5>
<div style="margin-left: 0 ; border: 2px">
<p>
            Why do we need this 'linkmap' pipeline generating dynamic XML from
            <span class="codefrag">site.xml</span>, instead of just using <span class="codefrag">site.xml</span> directly?  The reasons are described
            in <a class="external" href="http://marc.theaimsgroup.com/?l=forrest-dev&m=103444028129281&w=2">the linkmap RT</a>: we need to
            concatenate @hrefs and add ..'s to the paths, depending on which
            directory the linkee is in.  This is done with the following
            pipelines in <span class="codefrag">linkmap.xmap</span>:
          </p>
<pre class="code">
&lt;!-- site.xml with @href's appended to be context-relative. --&gt;
&lt;map:match pattern="abs-linkmap"&gt;
  &lt;map:generate src="content/xdocs/site.xml" /&gt;
  &lt;map:transform src="resources/stylesheets/absolutize-linkmap.xsl" /&gt;
  &lt;map:serialize type="xml" /&gt;
&lt;/map:match&gt;

&lt;!-- Linkmap for regular pages --&gt;
&lt;map:match pattern="**linkmap-*"&gt;
  &lt;map:generate src="cocoon://abs-linkmap" /&gt;
  &lt;map:transform src="resources/stylesheets/relativize-linkmap.xsl"&gt;
    &lt;map:parameter name="path" value="{1}{2}" /&gt;
    &lt;map:parameter name="site-root" value="{conf:project-url}" /&gt;
  &lt;/map:transform&gt;
  &lt;map:serialize type="xml" /&gt;
&lt;/map:match&gt;
            </pre>
<p>You can try these URIs out directly on a live Forrest to see what
            is going on (for example, Forrest's own <a href="abs-linkmap">abs-linkmap</a> and <a href="linkmap-index.html">linkmap-index.html</a>.
          </p>
</div>
</div>
</div>
  
<div class="attribution">
<span class="version">
          version 1.6</span>
</div>
</div>
</td><td width="10"><img width="10" height="1" alt="" src="skin/images/spacer.gif" class="spacer"></td>
</tr>
<!--================= end Content==================-->
</table>
</td>
</tr>
</table>
<!--================= end Menu, NavBar, Content ==================-->
<!--================= start Footer ==================-->
<table summary="footer" cellspacing="0" cellpadding="0" width="100%" border="0">
<tr>
<td colspan="2" height="1" bgcolor="#4C6C8F"><img height="1" width="1" alt="" src="skin/images/spacer.gif" class="spacer"><a href="skin/images/label.gif"></a><a href="skin/images/page.gif"></a><a href="skin/images/chapter.gif"></a><a href="skin/images/chapter_open.gif"></a><a href="skin/images/current.gif"></a></td>
</tr>
<tr>
<td colspan="2" bgcolor="#CFDCED" class="copyright" align="center"><font size="2" face="Arial, Helvetica, Sans-Serif"><a href="http://www.apache.org/licenses/LICENSE-2.0">
              Copyright &copy; 2002-2004&nbsp;
              The Apache Software Foundation.</a>
          All rights reserved.
          <script type="text/javascript" language="JavaScript"><!--
              document.write(" - "+"Last Published: " + document.lastModified);
            //  --></script></font></td>
</tr>
<tr>
<td colspan="2" align="left" bgcolor="#CFDCED" class="logos"></td>
</tr>
</table>
<!--================= end Footer ==================-->
</body>
</html>
